<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil dos Técnicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: rgba(40, 40, 40, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .profile-card {
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
        }

        .profile-card:hover {
            transform: translateY(-2px);
            border-color: #6366f1;
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.2);
        }

        .profile-card.expanded {
            border-color: #6366f1;
            background: rgba(50, 50, 50, 0.9);
        }

        .details-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0, 1, 0, 1);
        }

        .profile-card.expanded .details-panel {
            max-height: 500px;
            transition: max-height 0.5s cubic-bezier(1, 0, 1, 0);
        }

        .stat-badge {
            transition: transform 0.2s;
        }

        .stat-badge:hover {
            transform: scale(1.05);
        }

        /* Avatar generation colors */
        .avatar-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>

<body class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-10 text-center relative">
            <a href="index.html"
                class="absolute left-0 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <h1 class="text-3xl font-bold text-white mb-2">
                <i class="fas fa-users text-indigo-500 mr-3"></i>Equipe Técnica
            </h1>
            <p class="text-gray-400">Desempenho e estatísticas em tempo real</p>
        </div>

        <!-- Filter/Search (Optional future feature, simplified for now) -->
        <div class="mb-8 relative max-w-md mx-auto">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-500"></i>
            </div>
            <input type="text" id="searchInput"
                class="block w-full pl-10 pr-3 py-3 border border-gray-700 rounded-xl leading-5 bg-gray-800 text-gray-100 placeholder-gray-500 focus:outline-none focus:bg-gray-700 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm transition-colors"
                placeholder="Buscar técnico..." onkeyup="filterTechnicians()">
        </div>

        <!-- Technicians List -->
        <div id="techniciansList" class="space-y-4">
            <!-- Loading State -->
            <div class="flex flex-col items-center justify-center py-20 text-gray-500">
                <i class="fas fa-circle-notch fa-spin text-3xl mb-4 text-indigo-500"></i>
                <p>Carregando perfis...</p>
            </div>
        </div>

        <!-- Empty State (Hidden by default) -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-gray-500 text-center">
            <i class="fas fa-user-slash text-4xl mb-4 text-gray-600"></i>
            <p class="text-lg">Nenhum técnico encontrado.</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Config -->
    <script src="firebase-config.js"></script>

    <script>
        let allTechnicians = [];

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            if (initFirebase()) {
                loadTechnicians();
                // Opcional: ouvir mudanças em tempo real se desejar
                // db.collection('stats').doc('technicians_current').onSnapshot(...)
            } else {
                showError('Falha ao conectar ao banco de dados.');
            }
        });

        async function loadTechnicians() {
            const listContainer = document.getElementById('techniciansList');
            
            try {
                const data = await getTechniciansData();
                
                if (!data || data.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                    listContainer.innerHTML = '';
                    return;
                }

                allTechnicians = data;
                renderTechnicians(allTechnicians);

            } catch (error) {
                console.error(error);
                showError('Erro ao carregar os dados.');
            }
        }

        function renderTechnicians(technicians) {
            const listContainer = document.getElementById('techniciansList');
            listContainer.innerHTML = '';

            if (technicians.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            } else {
                document.getElementById('emptyState').classList.add('hidden');
            }

            technicians.forEach((tech, index) => {
                const card = createTechnicianCard(tech, index);
                listContainer.appendChild(card);
            });
        }

        function createTechnicianCard(tech, index) {
            const card = document.createElement('div');
            card.className = `glass-panel p-4 profile-card animate-fade-in`;
            card.style.animationDelay = `${index * 0.05}s`;
            
            // Generate initials and color
            const initials = getInitials(tech.name);
            const color = getRandomColor(tech.name);

            // Handle undefined values safely
            const completed = tech.count || 0;
            const redo = tech.refeito || 0;
            const openOs = tech.osAberta || 0;

            card.innerHTML = `
                <div class="flex items-center justify-between" onclick="toggleDetails(this)">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg" 
                             style="background-color: ${color}">
                            ${initials}
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white">${tech.name}</h3>
                            <div class="flex items-center text-sm text-gray-400">
                                <span class="bg-gray-700 px-2 py-0.5 rounded text-xs mr-2">Rank #${index + 1}</span>
                                <span>${completed} Configurações</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-gray-400">
                        <i class="fas fa-chevron-down transition-transform duration-300 transform"></i>
                    </div>
                </div>
                
                <div class="details-panel text-gray-300">
                    <div class="pt-4 mt-4 border-t border-gray-700 grid grid-cols-3 gap-4 text-center">
                        <div class="stat-badge bg-gray-800 p-3 rounded-lg">
                            <div class="text-indigo-400 text-xs uppercase font-bold tracking-wider mb-1">Configurados</div>
                            <div class="text-2xl font-bold text-white">${completed}</div>
                            <i class="fas fa-check-circle text-gray-600 mt-2 text-sm"></i>
                        </div>
                        <div class="stat-badge bg-gray-800 p-3 rounded-lg">
                            <div class="text-red-400 text-xs uppercase font-bold tracking-wider mb-1">Refeitos</div>
                            <div class="text-2xl font-bold text-white">${redo}</div>
                            <i class="fas fa-rotate-left text-gray-600 mt-2 text-sm"></i>
                        </div>
                        <div class="stat-badge bg-gray-800 p-3 rounded-lg">
                            <div class="text-yellow-400 text-xs uppercase font-bold tracking-wider mb-1">O.S. Aberta</div>
                            <div class="text-2xl font-bold text-white">${openOs}</div>
                            <i class="fas fa-exclamation-triangle text-gray-600 mt-2 text-sm"></i>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-2 text-xs text-gray-500 text-center">
                        Última atualização: ${new Date().toLocaleDateString('pt-BR')}
                    </div>
                </div>
            `;

            return card;
        }

        function toggleDetails(header) {
            const card = header.parentElement;
            const isExpanded = card.classList.contains('expanded');
            const icon = card.querySelector('.fa-chevron-down');

            // Close all others (optional - commented out to allow multiple open)
            // document.querySelectorAll('.profile-card.expanded').forEach(c => {
            //     if (c !== card) {
            //         c.classList.remove('expanded');
            //         c.querySelector('.fa-chevron-down').style.transform = 'rotate(0deg)';
            //     }
            // });

            card.classList.toggle('expanded');
            
            if (card.classList.contains('expanded')) {
                icon.style.transform = 'rotate(180deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function filterTechnicians() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            
            const filtered = allTechnicians.filter(tech => 
                tech.name.toLowerCase().includes(filter)
            );
            
            renderTechnicians(filtered);
        }

        function getInitials(name) {
            if (!name) return '--';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return `${parts[0][0]}${parts[parts.length - 1][0]}`.toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function getRandomColor(name) {
            if (!name) return '#555';
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = Math.abs(hash % 360);
            return `hsl(${h}, 70%, 55%)`; // Adjusted for better visibility on dark bg
        }

        function showError(msg) {
            const list = document.getElementById('techniciansList');
            list.innerHTML = `<div class="text-center text-red-500 py-10"><i class="fas fa-exclamation-circle text-2xl mb-2"></i><p>${msg}</p></div>`;
        }
    </script>
</body>

</html>